{
	"name": "RosterfyLakehouse",
	"properties": {
		"folder": {
			"name": "SQL Serverless"
		},
		"content": {
			"query": "--DROP DATABASE RosterfyLakehouse;\n\nCREATE DATABASE RosterfyLakehouse COLLATE Latin1_General_100_BIN2_UTF8;\n\nUSE RosterfyLakehouse;\nGO\n\nCREATE MASTER KEY ENCRYPTION BY PASSWORD = '2A4iTR622$Aa29M*5s!RFouT8Fd^WtkE';\n\nCREATE DATABASE SCOPED CREDENTIAL WorkspaceIdentity\nWITH IDENTITY = 'Managed Identity';\nGO\nCREATE EXTERNAL DATA SOURCE ExtDSCurated WITH (\n    LOCATION = 'https://stldatalakedev.dfs.core.windows.net/curated/Rosterfy/',\n    CREDENTIAL = WorkspaceIdentity\n);\n\nCREATE EXTERNAL FILE FORMAT ParquetFormat WITH (  FORMAT_TYPE = PARQUET );\n\nCREATE SCHEMA rfy;\n\n-- prepare view for Rosterfy User\nDROP VIEW IF EXISTS rfy.vwRosterfyUser;\n\nCREATE VIEW rfy.vwRosterfyUser AS\nSELECT\n    *\nFROM\n    OPENROWSET(\n        BULK 'User/*.parquet',\n        DATA_SOURCE = 'ExtDSCurated',\n        FORMAT='PARQUET'\n    ) AS vwRU;\n\n-- prepare view for Rosterfy BookedShift\nDROP VIEW IF EXISTS rfy.vwRosterfyBookedShift;\nGO;\n\nCREATE VIEW rfy.vwRosterfyBookedShift AS\nSELECT\n    *\nFROM\n    OPENROWSET(\n        BULK 'BookedShift/*.parquet',\n        DATA_SOURCE = 'ExtDSCurated',\n        FORMAT='PARQUET'\n    ) AS vwRBS;\n\n\n-- prepare view for Rosterfy Shift\nDROP VIEW IF EXISTS rfy.vwRosterfyShift;\nGO;\n\nCREATE VIEW rfy.vwRosterfyShift AS\nSELECT\n    *\nFROM\n    OPENROWSET(\n        BULK 'Shift/*.parquet',\n        DATA_SOURCE = 'ExtDSCurated',\n        FORMAT='PARQUET'\n    ) AS vwRBS;\n\n--select top 20 * from rfy.vwRosterfyShift;\n\n-- prepare view for Rosterfy Event\nDROP VIEW IF EXISTS rfy.vwRosterfyEvent;\nGO;\n\nCREATE VIEW rfy.vwRosterfyEvent AS\nSELECT\n    *\nFROM\n    OPENROWSET(        \n        BULK 'Event/*.parquet',\n        DATA_SOURCE = 'ExtDSCurated',\n        FORMAT='PARQUET'\n    ) AS vwRos;\n\n\nselect top 20 * from rfy.vwRosterfyUser;\n\n--cross database queries - supported by serverless SQL pools\n--The queries can reference the serverless SQL databases or the Lake databases in the same workspace. Cross-workspace queries are not supported.\nselect top 50\na.id,\na.email,\nb.object_first_name,\nb.object_last_name\nfrom rfy.vwRosterfyUser a inner join logicalDW.LDW.vwRosterfyUser b\nON a.id = b.id\n;\n\nselect top 20 * from rfy.vwRosterfyUser\nWHERE object_first_name = 'Jason'\n;\n--where InsertedOn='2022-03-17T23:25:39.8930000';\n\n\n--create a table of curated columns to expose as SQL tables via serverless SQL endpoint \n--only serve up data rows which are current (where isCurrent=1)\n--subfolder in lake must not exist (delete with ADF)\nCREATE EXTERNAL TABLE [rfy].[extRosterfyUser] WITH (\n        LOCATION = 'CETAS/User',\n        DATA_SOURCE = ExtDSCurated,\n        FILE_FORMAT = ParquetFormat\n) AS\nSELECT\n    *\nFROM\n(\n    SELECT\n    RANK() OVER (PARTITION by id ORDER BY InsertedOn DESC) as isCurrent\n     --, *\n    ,id\n    ,email\n    ,object_first_name\n    ,object_last_name\n    ,object_team_member_id\n    ,object_employment_status\n    ,object_state\n    ,nice_name\n    ,updated_hours\n    ,created_at\n    ,updated_at\n\n    FROM \n    OPENROWSET(\n        BULK 'User/*.parquet',\n        DATA_SOURCE = 'ExtDSCurated',\n        FORMAT = 'PARQUET'\n    )  AS r\n) AS t\nWHERE isCurrent = 1\n;\n\n--returns only the most up-to-date row for Jason\nselect top 20 * from rfy.extRosterfyUser\nWHERE object_first_name = 'Jason'\n;\n\n\nselect count(*) as cnt from [rfy].[extRosterfyUser];\n\n--CETAS Rosterfy BookedShift\nCREATE EXTERNAL TABLE [rfy].[extRosterfyBookedShift] WITH (\n        LOCATION = 'CETAS/BookedShift',\n        DATA_SOURCE = ExtDSCurated,\n        FILE_FORMAT = ParquetFormat\n) AS\nSELECT\n    *\nFROM \n    OPENROWSET(\n        BULK 'BookedShift/*.parquet',\n        DATA_SOURCE = 'ExtDSCurated',\n        FORMAT='PARQUET'\n) AS r\n;\n\nselect top 20 * from rfy.extRosterfyBookedShift;\n\n--CETAS Rosterfy Shift\nCREATE EXTERNAL TABLE [rfy].[extRosterfyShift] WITH (\n        LOCATION = 'CETAS/Shift',\n        DATA_SOURCE = ExtDSCurated,\n        FILE_FORMAT = ParquetFormat\n) AS\nSELECT\n    *\nFROM \n    OPENROWSET(\n        BULK 'Shift/*.parquet',\n        DATA_SOURCE = 'ExtDSCurated',\n        FORMAT='PARQUET'\n) AS r\n;\n\nselect top 20 * from rfy.extRosterfyShift;\n\n\n--CETAS Rosterfy Event\nCREATE EXTERNAL TABLE [rfy].[extRosterfyEvent] WITH (\n        LOCATION = 'CETAS/Event',\n        DATA_SOURCE = ExtDSCurated,\n        FILE_FORMAT = ParquetFormat\n) AS\nSELECT\n    *\nFROM \n    OPENROWSET(\n        BULK 'Event/*.parquet',\n        DATA_SOURCE = 'ExtDSCurated',\n        FORMAT='PARQUET'\n) AS r\n;\n\nselect top 20 * from rfy.extRosterfyEvent;\n\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "RosterfyLakehouse",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}