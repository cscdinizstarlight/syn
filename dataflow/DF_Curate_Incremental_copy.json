{
	"name": "DF_Curate_Incremental_copy",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"linkedService": {
						"referenceName": "datalake",
						"type": "LinkedServiceReference"
					},
					"name": "todayCleansedData"
				},
				{
					"linkedService": {
						"referenceName": "datalake",
						"type": "LinkedServiceReference"
					},
					"name": "allRosterfyUser"
				},
				{
					"linkedService": {
						"referenceName": "datalake",
						"type": "LinkedServiceReference"
					},
					"name": "getAllRecords"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "DS_Curated_Rosterfy_User",
						"type": "DatasetReference"
					},
					"name": "sinkIncrementalData"
				},
				{
					"name": "cacheMaxSurrKey"
				}
			],
			"transformations": [
				{
					"name": "addRowHash"
				},
				{
					"name": "AddSurrogateKey"
				},
				{
					"name": "keepRowHash"
				},
				{
					"name": "chkNewRows"
				},
				{
					"name": "seedSurrogateKey"
				},
				{
					"name": "addDateColumn"
				},
				{
					"name": "MaxSurrogateKey"
				},
				{
					"name": "select1"
				},
				{
					"name": "select2"
				},
				{
					"name": "select3"
				}
			],
			"scriptLines": [
				"parameters{",
				"     DFParamPLTriggerTime as timestamp (toTimestamp('1999-01-01 00:00:01')),",
				"     SinkFolder as string ('Rosterfy/Event'),",
				"     SurrogateColumn as string ('SurrogateKey'),",
				"     CurrentSinkFolder as string ('Rosterfy/Event/2022/09/09'),",
				"     CurrentFileName as string ('part-00000-5c4afb30-fcac-428a-b027-6b12b459b737-c000.csv')",
				"}",
				"source(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false,",
				"     format: 'delimited',",
				"     fileSystem: 'cleansed',",
				"     folderPath: ($CurrentSinkFolder),",
				"     fileName: ($CurrentFileName),",
				"     columnDelimiter: ',',",
				"     escapeChar: '\\\\',",
				"     quoteChar: '\\\"',",
				"     columnNamesAsHeader: false,",
				"     multiLineRow: true) ~> todayCleansedData",
				"source(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false,",
				"     format: 'parquet',",
				"     fileSystem: 'curated',",
				"     wildcardPaths:[(concat($SinkFolder, \"/*/*/*/*.parquet\"))]) ~> allRosterfyUser",
				"source(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false,",
				"     format: 'parquet',",
				"     fileSystem: 'curated',",
				"     wildcardPaths:[(concat($SinkFolder, \"/*/*/*/*.parquet\"))]) ~> getAllRecords",
				"todayCleansedData derive(rowHash = sha2(256, columns())) ~> addRowHash",
				"addDateColumn keyGenerate(output(SurrogateKey as long),",
				"     startAt: 1L,",
				"     stepValue: 1L) ~> AddSurrogateKey",
				"select2 select(mapColumn(",
				"          each(match(true()))",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> keepRowHash",
				"select3, keepRowHash exists(rowHash == rowHash,",
				"     negate:true,",
				"     broadcast: 'auto')~> chkNewRows",
				"AddSurrogateKey derive(SurrogateKey = SurrogateKey + cacheMaxSurrKey#outputs()[1].maxSurrogateKey) ~> seedSurrogateKey",
				"chkNewRows derive(InsertedOn = $DFParamPLTriggerTime) ~> addDateColumn",
				"select1 aggregate(each(match(true()), $$ = max($$))) ~> MaxSurrogateKey",
				"getAllRecords select(mapColumn(",
				"          each(match(locate('surrogatekey', lower(name))==1),",
				"               'SurrogateKey' = $$)",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> select1",
				"allRosterfyUser select(mapColumn(",
				"          each(match(locate('rowhash', lower(name))==1),",
				"               'rowHash' = $$)",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> select2",
				"addRowHash select(mapColumn(",
				"          rowHash",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> select3",
				"seedSurrogateKey sink(allowSchemaDrift: true,",
				"     validateSchema: true,",
				"     format: 'parquet',",
				"     umask: 0022,",
				"     preCommands: [],",
				"     postCommands: [],",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> sinkIncrementalData",
				"MaxSurrogateKey sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     store: 'cache',",
				"     format: 'inline',",
				"     output: false,",
				"     saveOrder: 1) ~> cacheMaxSurrKey"
			]
		}
	}
}